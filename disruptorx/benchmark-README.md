# DisruptorX 性能基准测试工具

此工具用于对DisruptorX分布式工作流框架进行全面的性能测试和压力测试，帮助用户了解系统在不同配置和负载条件下的性能特性。

## 功能特点

- **全面的测试参数** - 支持配置消息速率、消息大小、节点数量、线程数等参数
- **多种测试模式** - 提供快速测试、标准测试和完整测试套件
- **详细的性能报告** - 生成包含延迟分布、吞吐量和资源使用情况的详细报告
- **HDR直方图** - 使用高动态范围(HDR)直方图记录微秒级延迟
- **批处理能力测试** - 评估不同批处理大小对性能的影响

## 快速开始

```bash
# 进入项目目录
cd disruptorx

# 运行快速测试
./scripts/run-benchmark.sh quick

# 运行标准测试
./scripts/run-benchmark.sh
```

## 测试模式

工具支持以下测试模式：

| 模式 | 描述 | 命令 |
|------|------|------|
| 快速测试 | 短时间运行的基本测试 | `./scripts/run-benchmark.sh quick` |
| 标准测试 | 默认的标准测试，包括单节点和多节点测试 | `./scripts/run-benchmark.sh` |
| 单节点扩展测试 | 测试不同消息速率下的单节点性能 | `./scripts/run-benchmark.sh single-node` |
| 多节点扩展测试 | 测试不同节点数量下的性能扩展能力 | `./scripts/run-benchmark.sh multi-node` |
| 消息大小测试 | 测试不同消息大小对性能的影响 | `./scripts/run-benchmark.sh message-size` |
| 线程数测试 | 测试不同生产者和消费者线程数的影响 | `./scripts/run-benchmark.sh threads` |
| 批处理大小测试 | 测试不同批处理大小的性能特性 | `./scripts/run-benchmark.sh batch` |
| 完整测试套件 | 运行所有测试模式的组合 | `./scripts/run-benchmark.sh full` |
| 自定义测试 | 使用自定义参数进行测试 | `./scripts/run-benchmark.sh custom "-d 60 -r 100000"` |

## 测试参数

可通过命令行参数自定义测试配置：

| 参数 | 描述 | 默认值 |
|------|------|--------|
| `-d, --duration` | 测试持续时间（秒） | 30 |
| `-w, --warmup` | 预热时间（秒） | 10 |
| `-r, --rate` | 目标消息速率（消息/秒） | 10000 |
| `-s, --size` | 消息大小（字节） | 1024 |
| `-n, --nodes` | 节点数量 | 1 |
| `-p, --producers` | 生产者线程数 | 4 |
| `-c, --consumers` | 消费者线程数 | 4 |
| `-b, --batch` | 批处理大小 | 100 |
| `-h, --help` | 显示帮助信息 | - |

示例：
```bash
# 自定义测试：3节点集群，持续60秒，200,000消息/秒，8个生产和消费线程
./scripts/run-benchmark.sh custom "-d 60 -r 200000 -n 3 -p 8 -c 8"
```

## 测试报告

测试结果保存在 `benchmark-results/` 目录中，每次测试会创建带有时间戳的子目录。每个测试报告包含：

1. `report.txt` - 包含测试配置和结果的文本报告
2. `latency_histogram.hgrm` - 延迟分布的HDR直方图文件
3. `publishing_rate_histogram.hgrm` - 消息发布速率的HDR直方图文件

## 结果分析

### 延迟分析
报告中包含的延迟指标：
- 最小延迟 - 观察到的最小消息延迟（微秒）
- 最大延迟 - 观察到的最大消息延迟（微秒）
- 平均延迟 - 所有消息的平均延迟（微秒）
- 中位数延迟 - 50%消息的延迟（微秒）
- 90%/99%/99.9%/99.99% - 对应百分位数的延迟（微秒）

### 吞吐量分析
报告中包含的吞吐量指标：
- 总消息数 - 测试期间成功处理的消息总数
- 实际吞吐量 - 实际达到的每秒消息处理数量
- 发布速率 - 每条消息的平均发布时间（微秒）

## 典型性能特征

在标准硬件上（8核CPU，16GB内存），DisruptorX框架通常能达到以下性能指标：

- 单节点吞吐量：> 500,000 消息/秒
- 端到端延迟（中位数）：< 100 微秒
- 99.9%延迟：< 10 毫秒
- 线性扩展能力：节点数量增加时吞吐量接近线性增长

## 性能优化建议

1. **增加批处理大小** - 对于高吞吐量场景，增加批处理大小可以显著提高性能
2. **调整线程数** - 线程数应与CPU核心数匹配，过多的线程可能导致上下文切换开销
3. **使用更大的RingBuffer** - 增加RingBuffer大小可以提高峰值负载处理能力
4. **调优GC** - 使用G1GC并调整堆大小可以减少GC暂停
5. **减少消息大小** - 较小的消息可以提高缓存效率和网络传输效率

## 已知限制

- 当消息速率超过系统处理能力时，延迟会显著增加
- 网络延迟在多节点测试中可能成为主要瓶颈
- 在资源受限环境中，测试结果可能与标准硬件上的结果有显著差异

## 故障排除

如果测试过程中遇到问题：

1. **内存不足** - 增加JVM堆大小 `-Xmx`
2. **节点连接失败** - 检查网络配置或防火墙设置
3. **吞吐量低于预期** - 检查系统资源使用情况，可能是CPU或网络成为瓶颈
4. **报告不完整** - 确保目录有写入权限

## 许可证

DisruptorX性能基准测试工具基于Apache License 2.0开源。 